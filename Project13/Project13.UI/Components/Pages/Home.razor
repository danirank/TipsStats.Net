@page "/"
@using Project13.Stats.Core.Models
@using Project13.Tips.Api.Models
@using Project13.UI.Services;



@using Project13.Tips.Api.Constants
<PageTitle>Project13</PageTitle>


<h1>Tippa</h1>



<div class="container-fluid">


    <div class="row">
        <div class="col-5">
            <div class="card">
                <div class="card-header text-lg-center bg-light">
                    <h2>Kupong</h2>

                </div>
                <div class="card-body">
                    @if (matcher is null || matcher.Count == 0)
                    {
                        if (!isLoadingMatcher)
                        {
                            <button type="button" @onclick="LoadCoupon">Ladda kupong</button>

                        } else
                        {
                            <p>Laddar...</p>
                        }
                    }
                    else
                    {

                        @foreach (var match in matcher)
                        {
                            predictionsTexts.TryAdd(match.HomeTeam, string.Empty);
                            <div class="container">
                                <div class="row">
                                    <div class="col-6">
                                        <p><strong>@match.MatchNo. @match.HomeTeam - @match.AwayTeam</strong></p>
                                    </div>
                                    <div class="col-2">
                                        <button @onclick="()=>GetPrediction(match.HomeTeam)" class="btn btn-dark m-2">Prediction</button>
                                    </div>
                                    <div class="col-4">
                                        <textarea disabled id="prediction-@match.HomeTeam" @bind="@predictionsTexts[match.HomeTeam]" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
        <div class="col-7">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2>Agent analys</h2>
                </div>
                <div class="card-body">
                    <div>
                        <textarea class="form-control" style="height:300px" @bind="textArea">Await....</textarea>
                        <button class="btn btn-primary" @onclick="LoadAnalyzeAsync">Analyze</button>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>
@code {
    [Inject]
    public HttpClient Http { get; set; } = default!;

    [Inject]
    FootballStatsApiService FootballApi { get; set; } = default!;
    [Inject]
    CouponApiService CouponApi { get; set; } = default!;

    private IReadOnlyList<MatchInfoDto>? matcher { get; set; }
    private CouponDto? coupon { get; set; }
    private bool isLoadingMatcher = false;
    private string PredictionTextArea { get; set; } = "Not empty";
    private string? date { get; set;} =string.Empty;
    private string? teamName { get; set; } = string.Empty;
    private int? season { get; set;}
    private int? teamId { get; set; }
    private int? fixtureId { get; set; }
    private Dictionary<string, string> predictionsTexts { get; set; } = new();


    private string textArea = "Loading...";

    public async Task LoadAnalyzeAsync()
    {
        try
        {
            var data = new SearchAnalysisResult(
            SampleSize: 1000,

            TotDiff_P25: 1.2m,
            TotDiff_Median: 2.1m,
            TotDiff_P75: 3.4m,
            P_TotDiff_AtLeast3: 0.42m,
            P_TotDiff_AtLeast4: 0.18m,

            Skrallar_Median: 1.0m,
            P_Skrallar_AtLeast2: 0.33m,
            P_Skrallar_AtLeast3: 0.12m,

            Utd13_P25: 12000m,
            Utd13_Median: 45000m,
            Utd13_P75: 120000m,
            Utd13_Max: 800000m,

            MeanDisagreement_Median: 0.15m,
            DisagreementTop3Sum_Median: 0.42m,

            P_StrongestFavLoses: 0.22m,
            Utd13_Median_WhenStrongestFavLoses: 180000m,
            TotDiff_Median_WhenStrongestFavLoses: 1.4m
        );


            var response = await Http.PostAsJsonAsync("https://localhost:7245/analyze", data);

            response.EnsureSuccessStatusCode();

            textArea = await response.Content.ReadAsStringAsync();
        }
        catch (Exception ex)
        {
            textArea = ex.Message;
        }
    }

    public async Task LoadCoupon()
    {
        try
        {
            isLoadingMatcher = true;

            coupon = await CouponApi.GetCouponAsync();

            if (coupon is not null)
            {
                matcher = coupon.Matches;

            }
            isLoadingMatcher = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Något gick fel vid hämtning av kupong: Error: {ex.Message}");
        }
    }

    public async Task GetPrediction(string team)
    {

        try
        {
            var stringDate = "2025-12-20";
            var season = 2025;

            var result = await FootballApi.LoadPrediction(team,Countries.England,stringDate, season);

            if (result is not null)
            {
                predictionsTexts[team] = result;
           
            }


        }
        catch(Exception ex)
        {
            Console.WriteLine("Error loading prediction " + ex.Message);
            PredictionTextArea = ex.Message;
        }
    }

}